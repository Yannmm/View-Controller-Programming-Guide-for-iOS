# 翻译@View Controller Programming Guide for iOS（iOS视图控制器编程指南）

- 原文：[View Controller Programming Guide for iOS](https://developer.apple.com/library/content/featuredarticles/ViewControllerPGforiPhoneOS/index.html#//apple_ref/doc/uid/TP40007457-CH2-SW1)
- 作者：[Apple](https://developer.apple.com/library/content/navigation/)
- 更新：[Yannmm@Github.com](https://github.com/Yannmm/Auto-Layout-Guide-Chinese-Translation)

---

## Presentations and Transitions（呈现和转场）

### Using Segues（ Segue的使用）

storyborad segue用于定义界面关系，一个segue代表一次界面转换。转换的起点可以是按钮（UIButton），表格（UITableView）或手势（UITapGestureRecognizer）等元素；终点是新界面。segue可以显示控制器，也可以取消显示。

**图9-1** 两个控制器之间的segue

![图9-1]()

segue无需代码即可工作。UIKit自动加载，将其与元素绑定。交互时，相关控制器被自动创建，界面发生转换。转换前，会有通知发出，以便传输数据，或取消转换。


#### Creating a Segue Between View Controllers（ 创建segue）

segue只适用于同一个storyboard中的控制器：按住control点击任意元素，拖拽至目标控制器。起点元素可以是控件，手势，或动作对象（如UIBarButtonItem）；也可以是table view或collection view的cell。图9-2示范了如何以cell为起点创建segue。

**图9-2** 创建segue

![图9-2]()

>注意
>有些元素支持多个segue。例如，点击cell的不同位置（accesory button或其他部分），可以触发不同segue。

释放鼠标，从提示框中选择一种关系类型，如图9-3。按需选择即可。

**图9-3** 选择关系类型

![图9-3]()

尽量使用自适应segue（adaptive segue），其行为能够根据控制器环境自动调整。例如，Show segue的行为以呈现方为准。非自适应segue仅用于适配iOS7。表格9-1详细解释了自适应segue的行为。

**表格9-1** 自适应segue

Segue类型  | 行为
------------- | -------------
Show (Push)  | 实际调用目标控制器方法[showViewController:sender:](https://developer.apple.com/documentation/uikit/uiviewcontroller/1621377-showviewcontroller)。默认直接显示新控制器；但容器控制器通常重写上述方法。例如，导航控制器（UINavigationController）将新控制器入栈。<br>系统通过[targetViewControllerForAction:sender:](https://developer.apple.com/documentation/uikit/uiviewcontroller/1621415-targetviewcontroller)寻找目标控制器。
Show Detail(替换)  | 实际调用目标控制器方法[showDetailViewController:sender:](https://developer.apple.com/documentation/uikit/uiviewcontroller/1621432-showdetailviewcontroller)。这个segue仅针对[UISplitViewController](https://developer.apple.com/documentation/uikit/uisplitviewcontroller)生效。使用时，新控制器替换次级控制器。其余情况默认直接显示。<br>系统通过[targetViewControllerForAction:sender:](https://developer.apple.com/documentation/uikit/uiviewcontroller/1621415-targetviewcontroller)寻找目标控制器。
Present Modally  | 使用特定的呈现形式和转场效果直接显示新控制器。能够提供呈现环境的控制器扮演呈现方。
Present as Popover  | 正常宽度下，弹窗显示。紧凑宽下，直接显示。

在属性面板中为segue设置identifier，便于区分。identfier可以从[UIStoryboardSegue](https://developer.apple.com/documentation/uikit/uistoryboardsegue)对象身上读取。

#### Modifying a Segue’s Behavior at Runtime（ 动态修改segue）

segue的工作流程如图9-4所示。呈现方负责大部分转换工作。配置新控制器的方式与直接显示一样。再次强调，segue只适用于同一个storyboard中的两个控制器。

**图9-4** segue显示控制器

![图9-4]()

期间，下列方法依次调用：

- 方法[shouldPerformSegueWithIdentifier:sender:](https://developer.apple.com/documentation/uikit/uiviewcontroller/1621502-shouldperformseguewithidentifier)决定是否触发seuge。返回NO表示不触发，其他照旧。例如，点击表格相关代理方法依旧执行。
- 方法[prepareForSegue:sender:](https://developer.apple.com/documentation/uikit/uiviewcontroller/1621490-prepareforsegue)用于进行准备工作，如传递数据。其参数[UIStoryboardSegue](https://developer.apple.com/documentation/uikit/uistoryboardsegue)包含新控制器等信息。

#### Creating an Unwind Segue（ 反向segue）

反向segue即取消显示：通过IB将元素与控制器的Exit关联，即可创建。触发时，系统自动搜索目标控制器，取消当前及所有中间控制器的显示。

**反向segue创建步骤**

1. 选择目标控制器（即unwind segue结束后显示的控制器）；
2. 定义动作方法：
	- Swift：

		```
		@IBAction func myUnwindAction(unwindSegue: UIStoryboardSegue)
		```
	- Objective-C：

		```
		- (IBAction)myUnwindAction:(UIStoryboardSegue*)unwindSegue
		```

3. 找到发起unwind segue的控制器；
4. 按住Control点击一个元素；
5. 拖拽至上方的Exit；
6. 从关系面板中选择之前定义的动作方法。

![图9-5]()

注意，先定义动作方法，再创建unwind segue，顺序不能错。

动作方法的具体实现各异：一般来说，应该获取并处理数据，或更新目标控制器。取消显示的代码是不必要的，系统会自动补充。

记号

#### Initiating a Segue Programmatically（代码触发segue）

segue一般通过SB中的关联关系触发。然而，有时在SB中创建segue并不方便，可能是因为目标控制器是动态决定的。例如，一局游戏结束后，需要根据结果跳转至不同场景。这时，可以通过方法[performSegueWithIdentifier:sender:](https://developer.apple.com/documentation/uikit/uiviewcontroller/1621413-performsegue)触发segue。

代码9-1展示了当设备由横到竖旋转时，所触发的segue，它呈现一个控制器。由于此时通知队形对于segue毫无用处，所以当前控制器自发的座位segue的触发者。

**代码9-1** 代码触发segue

```
- (void)orientationChanged:(NSNotification *)notification {
    UIDeviceOrientation deviceOrientation = [UIDevice currentDevice].orientation;
    if (UIDeviceOrientationIsLandscape(deviceOrientation) &&
             !isShowingLandscapeView) {
        [self performSegueWithIdentifier:@"DisplayAlternateView" sender:self];
        isShowingLandscapeView = YES;
    }
// Remainder of example omitted.
}

```

#### Creating a Custom Segue（自定义segue）

IB提供多种标准segue，包括焦点呈现，或弹窗显示。然而，如果这些segue无法满足需要，我们可以自定义。

##### The Life Cycle of a Segue（Segue生命周期）

要理解自定义segue的工作流程，必须理解segue对象的生命周期。Segue对象就是[UIStoryboardSegue](https://developer.apple.com/documentation/uikit/uistoryboardsegue)或子类。App不需要直接创建这些对象；UIKit在seuge被触发时创建它们。以下是完整生命周期：

1. 创建和初始化要呈现的控制器。
2. segue对象通过方法[initWithIdentifier:source:destination:](https://developer.apple.com/documentation/uikit/uistoryboardsegue/1621908-initwithidentifier)创建。标识符必须是你提供给IB的唯一字符串，其他两个参数代表过渡的两个控制器。
3. 呈现方的方法[prepareForSegue:sender:](https://developer.apple.com/documentation/uikit/uiviewcontroller/1621490-prepareforsegue)被调用。更多信息，详见[Modifying a Segue’s Behavior at Runtime](https://developer.apple.com/library/content/featuredarticles/ViewControllerPGforiPhoneOS/UsingSegues.html#//apple_ref/doc/uid/TP40007457-CH15-SW11)。
4. segue对象方法[perform](https://developer.apple.com/documentation/uikit/uistoryboardsegue/1621912-perform)被调用。这个方法负责执行转场，将新内容展示在屏幕上。
5. segue对象被释放。

##### Implementing a Custom Segue（实现自定义segue）

要实现自定义segue，创建`UIStoryboardSegue`的子类，并实现以下方法：

- 重写方法`initWithIdentifier:source:destination:`，初始化自定义segue对象。记得先调用`super`。
- 实现方法`perform`，在其中配置转场动画。

>注意
>
>如果需要为segue添加属性，则这些属性无法在IB中直接配置。相反，必须在[prepareForSegue:sender:](https://developer.apple.com/documentation/uikit/uiviewcontroller/1621490-prepareforsegue)方法中进行。

代码9-2展示了一个十分简单的自定义segue。这个例子无序动画，直接呈现控制器，但是我们可以自行发挥。

**代码9-2** 自定义segue

```
- (void)perform {
    // Add your own animation code here.
 
    [[self sourceViewController] presentViewController:[self destinationViewController] animated:NO completion:nil];
}
```